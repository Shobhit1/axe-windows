name: $(date:yyyy-MM-dd)$(rev:.rr)
trigger: none
pr: none
variables:
  BuildPlatform: 'x86'
  DropFolder: 'signed'
  MAICreateNuget: 'true'
  PublicRelease: 'true'
  SignAppForRelease: 'true'
  TeamName: 'Accessibility Insights Windows'
  system.debug: 'true' #set to true in case our signed build flakes out again
  FAKES_SUPPORTED: 1
  Major: '0'
  Minor: '1'
  Patch: '0'

jobs:
- job: SignedRelease
  pool: VSEng-MicroBuildVS2017
  steps:
  - task: ms-vseng.MicroBuildTasks.a0262b21-fb8f-46f8-bb9a-60ed560d4a87.MicroBuildLocalizationPlugin@1
    displayName: 'Install Localization Plugin'

  - task: ms-vseng.MicroBuildTasks.30666190-6959-11e5-9f96-f56098202fef.MicroBuildSigningPlugin@1
    displayName: 'Install Signing Plugin'
    inputs:
      signType: real

  - task: NuGetToolInstaller@0
    displayName: 'Use NuGet 4.3.0'

  - task: NuGetCommand@2
    displayName: 'NuGet restore'

  - task: VSBuild@1
    displayName: 'Build Solution **\*.sln'
    inputs:
      vsVersion: 15.0
      platform: '$(BuildPlatform)'
      configuration: release

  - task: NuGetCommand@2
    inputs:
      command: pack
      packagesToPack: '**/*.csproj'
      versioningScheme: byPrereleaseNumber
      majorVersion: '$(Major)'
      minorVersion: '$(Minor)'
      patchVersion: '$(Patch)'

  - task: CopyFiles@2
    displayName: 'Copy Files to: $(Build.ArtifactStagingDirectory)'
    inputs:
      Contents: '**\bin\release\**'
      TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: drop'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact: msi'
    inputs:
      PathtoPublish: 'src\bin\Release\NUGET'
      ArtifactName: 'msi'

  - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: $(DropFolder)'
      inputs:
        PathtoPublish: 'src\bin\Release\NUGET'
        ArtifactName: '$(DropFolder)'
        publishLocation: FilePath
        TargetPath: '$(DropRoot)'

  - task: ms-vseng.MicroBuildTasks.521a94ea-9e68-468a-8167-6dcf361ea776.MicroBuildCleanup@1
    displayName: 'Perform Cleanup Tasks'
    condition: succeededOrFailed()
